<?xml version="1.0" encoding="iso-8859-1"?>
<project name="Hasher" default="all" basedir="./">
	<description>
		Hasher Build Task. Unify files, compress, validate, generate documentation and distribution files.
	</description>
	
	<!-- properties -->
	
    <property file="dev/build/build.properties"/>
	
	<!-- custom tasks -->
	
	<taskdef name="jslint" classname="com.googlecode.jslint4java.ant.JSLintTask" classpath="${jslint.jar}" />
	
	<!-- targets -->
	
	<target name="purge" description="Delete destination directories.">
		<delete dir="${deploy.dir}" />
    </target>
	
	<target name="-mkdirs" description="Make required dirs.">
		<mkdir dir="${deploy.dir}"/>
		<mkdir dir="${dist.dir}"/>
		<mkdir dir="${docs.dir}"/>
	</target>
	
	<target name="-purgeDocs">
		<delete dir="${docs.dir}" />
	</target>
	
	<target name="-purgeJS">
		<delete dir="${dist.dir}" />
	</target>
	
	<target name="concat" depends="-purgeJS, -mkdirs" description="Concatenate Files and outputs uncompressed version of Hasher.">
		<echo message="Building ${dist.name}" />
		<tstamp>
			<format property="build.date" pattern="yyyy/MM/dd hh:mm aa" unit="hour"/>
    	</tstamp>
    	<!--
		<concat destfile="${dist.dir}/${dist.name}" fixlastline="yes" eol="unix">
            <fileset file="${src.dir}/hasher.js" />
            <fileset file="${src.dir}/hasher.query.plugin.js" />
    	</concat>
    	-->
    	<copy todir="${dist.dir}">
    		<fileset dir="${src.dir}" />
    	</copy>
		<replace file="${dist.dir}/${dist.name}" token="::VERSION_NUMBER::" value="${version.number}"/>
		<replace file="${dist.dir}/${dist.name}" token="::BUILD_DATE::" value="${build.date}"/>
		<echo message="${dist.name} built" />
	</target>
	
	<target name="minify" description="Build minified version of Hasher.">
		<echo message="Building ${dist.min.name}" />
		<apply executable="java" parallel="false" verbose="true" dest="${dist.dir}">
		    <fileset dir="${dist.dir}">
		        <include name="*.js" />
		    </fileset>
		    <arg line="-jar" />
		    <arg path="${yuicompressor.jar}" />
		    <arg value="--charset" />
		    <arg value="ANSI" />
		    <arg value="-o" />
		    <targetfile />
		    <mapper type="glob" from="*.js" to="*.min.js" />
		</apply>
		<echo message="${dist.min.name} built." />
	</target>
	
	<target name="generateDocs" depends="-purgeDocs" description="Build Hasher and generates documentation.">
		<echo message="Generating documentation" />
 		<apply executable="java" parallel="false" verbose="true">
			<fileset dir="${dist.dir}">
				<include name="${dist.name}" />
			</fileset>
			<arg line="-jar" />
			<arg path="${jsdoc-toolkit.dir}/jsrun.jar" />
			<arg value="${jsdoc-toolkit.dir}/app/run.js" />
			<arg value="-t=${jsdoc-toolkit.dir}/templates/hasher" />
			<arg value="-d=${docs.dir}" />
		</apply>
		<echo message="Documentation generated" />
	</target>

	<target name="lint" description="Validate source code using JSLint.">
		<jslint haltOnFailure="false" options="browser, onevar, undef, bitwise, newcap, immed">
			<formatter type="plain" />
			<predef>window</predef>
			<fileset dir="${dist.dir}" includes="*.js" excludes="*.min.js" />
		</jslint>
	</target>

	<target name="compile" depends="concat, lint, minify">
		<echo message="Compiled." />
	</target>
	
	<target name="all" depends="purge, -mkdirs, compile, generateDocs">
		<echo message="Build Complete." />
	</target>
	
</project>