<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<link rel="stylesheet" href="./qunit/qunit.css" type="text/css" media="screen" />
		<script type="text/javascript" src="./qunit/qunit.js"></script>
		<script type="text/javascript" src="../../../dist/js/Hasher-0.9.8.js"></script>
		<title>Untitled</title>
	</head>
	<body>
		<h1 id="qunit-header">Hasher unit test #1</h1>
		<h2 id="qunit-banner"></h2>
		<h2 id="qunit-userAgent"></h2>
		<ol id="qunit-tests"></ol>
		<script type="text/javascript">
			
			/*
			 * 
			 * 		Hasher JS Unit test #1
			 * 		
			 * 		//TODO: split unit test, so back and forward tests are on a separate file. 
			 * 		
			 * 		-----------------------------------------------------------------------
			 * 
			 *		WARNING: 
			 * 			- poor code ahead!
			 * 			- don't use as reference!
			 * 
			 *		----------------------------------------------------------------------- 
			 * 
			 * 		IMPORTANT: 
			 * 			- unit test doesn't work properly on Chrome <= 6 because of browser bug:
			 * 			  http://code.google.com/p/chromium/issues/detail?id=45419
			 * 
			 * 		-----------------------------------------------------------------------
			 * 
			 */
			
			
			location.hash = ''; //resets location.hash
			
			
			/* ==== init hasher test ==== */
			
			test("init hasher", function(){
				stop(200);
				expect(4);
				
				ok(! Hasher.hasEventListener(HasherEvent.INIT), "No INIT Listener");
				
				Hasher.addEventListener(HasherEvent.INIT, function(){				
					ok(true, "HasherEvent.INIT dispatched");
					
					Hasher.removeEventListener(HasherEvent.INIT, arguments.callee);
					ok(! Hasher.hasEventListener(HasherEvent.INIT), "Removed INIT Listener");
					
					start();
				});
				
				ok(Hasher.hasEventListener(HasherEvent.INIT), "Added INIT Listener");
				
				Hasher.init();
			});
			/* == */
			
			
			/* ==== multiple listeners & changes ==== */
			
			module('multiple listeners & changes');
			
			function multipleTest(){
				
				stop(600);
				expect(32);
				
				function handler1(evt){
					ok(true, 'Called Handler #1');
				}
				
				function handler2(evt){
					ok(true, 'Called Handler #2');
				}
				
				function handler3(evt){
					ok(true, 'Called Handler #3');
				}
				
				Hasher.removeAllEventListeners(true);
				
				ok(!Hasher.hasEventListener(HasherEvent.CHANGE), "No CHANGE Listener");
				
				Hasher.addEventListener(HasherEvent.CHANGE, handler1);
				Hasher.addEventListener(HasherEvent.CHANGE, handler2);
				Hasher.addEventListener(HasherEvent.CHANGE, handler3);
				
				ok(Hasher.hasEventListener(HasherEvent.CHANGE), "Has CHANGE Listener");
				
				Hasher.setHash('Lorem');
				equals(Hasher.getHash(), 'Lorem');
				
				Hasher.setHash('Lorem/Ipsum');
				equals(Hasher.getHash(), 'Lorem/Ipsum');
				
				Hasher.setHash('Lorem/Dolor&Amet/?foo=bar&ipsum=dolor&n=123&nan=abc123');
				equals(Hasher.getHash(), 'Lorem/Dolor&Amet/?foo=bar&ipsum=dolor&n=123&nan=abc123');
				equals(Hasher.getHashQuery(), 'foo=bar&ipsum=dolor&n=123&nan=abc123');
				same(Hasher.getHashQueryAsObject(), {
					foo: 'bar',
					ipsum: 'dolor',
					n: 123,
					nan: 'abc123'
				});
				equals(Hasher.getHashQueryParam('n'), 123);
				equals(Hasher.getHashQueryParam('nan'), 'abc123');
				
				Hasher.setHash('?foo=bar&ipsum=dolor');
				equals(Hasher.getHash(), '?foo=bar&ipsum=dolor');
				equals(Hasher.getHashQuery(), 'foo=bar&ipsum=dolor');
				same(Hasher.getHashQueryAsObject(), {
					foo: 'bar',
					ipsum: 'dolor'
				});
				equals(Hasher.getHashQueryParam('foo'), 'bar');
				
				ok(! Hasher.hasEventListener(HasherEvent.INIT), "No INIT Listener");
				Hasher.addEventListener(HasherEvent.INIT, function(e){
					ok(false, "INIT event dispatched by accident"); //shouldn't run
				});
				ok(Hasher.hasEventListener(HasherEvent.INIT), "Has INIT Listener");
				
				
				ok(! Hasher.hasEventListener(HasherEvent.STOP), "No STOP Listener");
				Hasher.addEventListener(HasherEvent.STOP, function(e){
					ok(false, "STOP event dispatched by accident"); //shouldn't run
				});
				ok(Hasher.hasEventListener(HasherEvent.STOP), "Has STOP Listener");
				
				
				Hasher.removeAllEventListeners(HasherEvent.CHANGE);
				ok(! Hasher.hasEventListener(HasherEvent.CHANGE), "No CHANGE Listener");
				
				
				Hasher.removeAllEventListeners(true);
				ok(! Hasher.hasEventListener(HasherEvent.INIT), "No INIT Listener");
				ok(! Hasher.hasEventListener(HasherEvent.STOP), "No STOP Listener");
				
				location.hash = ''; //resets location.hash
				
				start();
				
			}
			
			test('#1', multipleTest);
			
			/* == */
			
			
			var testsHashs = [
				['foo', 'Foo Bar', ''],
				['dolor', 'Dolor Sit Amet', ''],
				['sit-amet/ipsum/?dolor=ipsum&maecennas=ullamcor', 'Sit Amet Ipsum', 'dolor=ipsum&maecennas=ullamcor'],
				['Spêçïãl/Chårs FTW', 'Spêçïãl Chårs', ''],
				['/asd', 'Asd', ''],
				['/asd/qwerty/?foo=bar', 'Qwerty / Asd / ? Foo = Bar', 'foo=bar'],
				['/asd/qwerty/', 'Asd Qwerty', '']
			];
			
			
			/* ==== set/get hash/title value ==== */
			
			module('set/get hash/title value');
			
			for(var i=0, t=testsHashs.length; i<t; i++){
				doChangeTest(i);
			}
			
			function doChangeTest(n){
				
				var testName = '#'+(n+1);
				
				var hash = testsHashs[n][0];
				var oldHash = (n > 0)? testsHashs[n-1][0] : '';
				var title = testsHashs[n][1];
				var hashQuery = testsHashs[n][2];
				
				var testFn = function(){
					stop(500);
					expect(11);
					
					Hasher.removeAllEventListeners(true);
					
					ok(! Hasher.hasEventListener(HasherEvent.CHANGE), "No CHANGE Listener");
					
					Hasher.addEventListener(HasherEvent.CHANGE, function(evt){
						ok(true, "HasherEvent.CHANGE dispatched");

						ok((evt.oldHash !== Hasher.getHash()), "Hash value really changed.");
						
						Hasher.removeEventListener(HasherEvent.CHANGE, arguments.callee);
						ok( ! Hasher.hasEventListener(HasherEvent.CHANGE), "Removed CHANGE Listener");
						
						equals(evt.oldHash, oldHash, "HasherEvent.oldHash");
						equals(Hasher.getHash(), evt.newHash, "HasherEvent.newHash == Hasher.getHash()");
						
						start();
					});
					
					ok(Hasher.hasEventListener(HasherEvent.CHANGE), "Attached CHANGE Listener");
					
					Hasher.setHash(hash);
					equals(Hasher.getHash(), hash, "Hasher.setHash() & Hasher.getHash()");
					
					var hashArray = hash.split('/');
					
					same(Hasher.getHashAsArray(), hashArray, "Hasher.getHashAsArray()");
					
					same(Hasher.getHashQuery(), hashQuery, "Hasher.getHashQuery()");
					
					Hasher.setTitle(title);
					equal(Hasher.getTitle(), document.title, "Hasher.setTitle() & Hasher.getTitle()");
				};
				
				test(testName, testFn);
				
			}
			/* == */
			
			
			/* ==== back ==== */
			
			module('back');
			
			var i = testsHashs.length - 1;
			
			while(i--){
				doBackTest(i);
			}
			
			
			function doBackTest(n){
				
				var testName = '#'+(n+1);
				
				var hash = testsHashs[n][0];
				var title = testsHashs[n][1];
				
				var testFn = function(){
					stop(200);
					expect(7);
					
					Hasher.removeAllEventListeners(true);
					
					ok(!Hasher.hasEventListener(HasherEvent.CHANGE), "No CHANGE Listener");
					
					Hasher.addEventListener(HasherEvent.CHANGE, function(evt){
					
						ok(true, "HasherEvent.CHANGE dispatched");
						
						Hasher.removeEventListener(HasherEvent.CHANGE, arguments.callee);
						ok(!Hasher.hasEventListener(HasherEvent.CHANGE), "Removed CHANGE Listener");
						
						equals(Hasher.getHash(), evt.newHash, "HasherEvent.newHash == Hasher.getHash()");
						equals(Hasher.getHash(), hash, "Hasher.getHash()");
						
						var hashArray = hash.split('/');
						
						same(Hasher.getHashAsArray(), hashArray, "Hasher.getHashAsArray()");
						
						start();
						
					});
					
					ok(Hasher.hasEventListener(HasherEvent.CHANGE), "Attached CHANGE Listener");
					
					Hasher.back();
				};
				
				test(testName, testFn);
			}
			/* == */
			
			
			/* ==== forward ==== */
			
			module('forward');
			
			for(var i=1, t=testsHashs.length; i<t; i++){
				doForwardTest(i);
			}
			
			
			function doForwardTest(n){
				
				var testName = '#'+(n+1);
				
				var hash = testsHashs[n][0];
				var title = testsHashs[n][1];
				
				var testFn = function(){
					stop(200);
					expect(7);
					
					Hasher.removeAllEventListeners(true);
					
					ok(!Hasher.hasEventListener(HasherEvent.CHANGE), "No CHANGE Listener");
					
					Hasher.addEventListener(HasherEvent.CHANGE, function(evt){
					
						ok(true, "HasherEvent.CHANGE dispatched");
						
						Hasher.removeEventListener(HasherEvent.CHANGE, arguments.callee);
						ok(!Hasher.hasEventListener(HasherEvent.CHANGE), "Removed CHANGE Listener");
						
						equals(Hasher.getHash(), evt.newHash, "HasherEvent.newHash == Hasher.getHash()");
						equals(Hasher.getHash(), hash, "Hasher.getHash()");
						
						var hashArray = hash.split('/');
						
						same(Hasher.getHashAsArray(), hashArray, "Hasher.getHashAsArray()");
						
						start();
						
					});
					
					ok(Hasher.hasEventListener(HasherEvent.CHANGE), "Attached CHANGE Listener");
					
					Hasher.forward();
				};
				
				test(testName, testFn);
			}
			/* == */
			
			
			/* ==== init and stop ==== */
			
			module('init and stop');
			
			var stopTest = function(){
				stop(200);
				expect(5);
				
				ok(Hasher.isActive(), "Is active");
				ok(! Hasher.hasEventListener(HasherEvent.STOP), "No STOP Listener");
				
				Hasher.addEventListener(HasherEvent.STOP, function(evt){
					
					ok(true, "HasherEvent.STOP dispatched");
					
					Hasher.removeEventListener(HasherEvent.STOP, arguments.callee);
					
					ok(! Hasher.hasEventListener(HasherEvent.STOP), "Removed STOP Listener");
					
					start();
				});
				
				ok(Hasher.hasEventListener(HasherEvent.STOP), "Attached STOP Listener");
				Hasher.stop();
			};
			
			var stopFailTest = function(){
				stop(200);
				expect(5);
				
				ok(! Hasher.isActive(), "Is not active");
				ok(! Hasher.hasEventListener(HasherEvent.STOP), "No STOP Listener");
				
				var handler = function(evt){
					ok(false, "HasherEvent.STOP dispatched"); //shouldn't happen
					Hasher.removeAllEventListeners(HasherEvent.STOP);
					start();
				};
				Hasher.addEventListener(HasherEvent.STOP, handler);
				
				ok(Hasher.hasEventListener(HasherEvent.STOP), "Attached STOP Listener");
				Hasher.stop();
				Hasher.stop();
				
				var delayedStart = function(){
					ok(true, 'Didn\'t dispatched STOP event.');
					Hasher.removeAllEventListeners(HasherEvent.STOP);
					ok(! Hasher.hasEventListener(HasherEvent.STOP), "Removed STOP Listener");
					start();
				};
				
				setTimeout(delayedStart, 100);
			};
			
			var initTest = function(){
				stop(200);
				expect(6);
				
				ok(! Hasher.isActive(), "Is not active");
				ok(! Hasher.hasEventListener(HasherEvent.INIT), "No INIT Listener");
				
				Hasher.addEventListener(HasherEvent.INIT, function(evt){
					ok(Hasher.isActive(), "Is active");
					ok(true, "HasherEvent.INIT dispatched");
					
					Hasher.removeEventListener(HasherEvent.INIT, arguments.callee);
					
					ok(! Hasher.hasEventListener(HasherEvent.INIT), "Removed INIT Listener");
					
					start();
				});
				
				ok(Hasher.hasEventListener(HasherEvent.INIT), "Attached INIT Listener");
				Hasher.init();
			};
			
			var initFailTest = function(){
				stop(200);
				expect(6);
				
				ok(Hasher.isActive(), "Is active");
				ok(! Hasher.hasEventListener(HasherEvent.INIT), "No INIT Listener");
				
				var handler = function(evt){
					ok(false, "HasherEvent.INIT dispatched"); //shouldn't happen
					Hasher.removeAllEventListeners(HasherEvent.INIT);
					start();
				};
				Hasher.addEventListener(HasherEvent.INIT, handler);
				
				ok(Hasher.hasEventListener(HasherEvent.INIT), "Attached INIT Listener");
				Hasher.init();
				Hasher.init();
				
				var delayedStart = function(){
					ok(true, 'Didn\'t dispatched INIT event.');
					ok(Hasher.isActive(), "Is active");
					Hasher.removeAllEventListeners(HasherEvent.INIT);
					ok(! Hasher.hasEventListener(HasherEvent.INIT), "Removed INIT Listener");
					start();
				};
				
				setTimeout(delayedStart, 100);
			};
			
			test('stop #1', stopTest);
			test('stop fail #1', stopFailTest);
			test('stop fail #2', stopFailTest);
			test('init #1', initTest);
			test('init fail #1', initFailTest);
			test('init fail #2', initFailTest);
			test('stop #2', stopTest);
			test('init #2', initTest);
			test('stop #3', stopTest);
			
			/* == */
			
			/* ==== disable events ==== */
			
			module('disable');
			
			
			var disableInitTest = function(){
				stop(200);
				expect(6);
				
				ok(! Hasher.isActive(), "Is not active");
				ok(! Hasher.hasEventListener(HasherEvent.INIT), "No INIT Listener");
				
				var handler = function(evt){
					ok(false, "HasherEvent.INIT dispatched"); //shouldn't happen
					Hasher.removeAllEventListeners(HasherEvent.INIT);
					start();
				};
				Hasher.addEventListener(HasherEvent.INIT, handler);
				
				ok(Hasher.hasEventListener(HasherEvent.INIT), "Attached INIT Listener");
				
				Hasher.disableEvent(HasherEvent.INIT);
				
				Hasher.init();
				
				var delayedStart = function(){
					ok(true, 'Didn\'t dispatched INIT event.');
					ok(Hasher.isActive(), "Is active");
					Hasher.removeAllEventListeners(HasherEvent.INIT);
					ok(! Hasher.hasEventListener(HasherEvent.INIT), "Removed INIT Listener");
					start();
				};
				
				setTimeout(delayedStart, 100);
				
			};
			
			
			var disableChangeTest = function(){
				stop(200);
				expect(6);
				
				ok(Hasher.isActive(), "Is active");
				ok(! Hasher.hasEventListener(HasherEvent.CHANGE), "No CHANGE Listener");
				
				var handler = function(evt){
					ok(false, "HasherEvent.CHANGE dispatched"); //shouldn't happen
					Hasher.removeAllEventListeners(HasherEvent.CHANGE);
					start();
				};
				Hasher.addEventListener(HasherEvent.CHANGE, handler);
				
				ok(Hasher.hasEventListener(HasherEvent.CHANGE), "Attached CHANGE Listener");
				
				Hasher.disableEvent(HasherEvent.CHANGE);
				
				Hasher.setHash('01');
				Hasher.setHash('02');
				Hasher.back();
				Hasher.forward();
				
				var delayedStart = function(){
					ok(true, 'Didn\'t dispatched CHANGE event.');
					ok(Hasher.isActive(), "Is active");
					Hasher.removeAllEventListeners(HasherEvent.CHANGE);
					ok(! Hasher.hasEventListener(HasherEvent.CHANGE), "Removed CHANGE Listener");
					start();
				};
				
				setTimeout(delayedStart, 100);
				
			};
			
			
			var disableStopTest = function(){
				stop(200);
				expect(6);
				
				ok(Hasher.isActive(), "Is active");
				ok(! Hasher.hasEventListener(HasherEvent.STOP), "No STOP Listener");
				
				var handler = function(evt){
					ok(false, "HasherEvent.STOP dispatched"); //shouldn't happen
					Hasher.removeAllEventListeners(HasherEvent.STOP);
					start();
				};
				Hasher.addEventListener(HasherEvent.STOP, handler);
				
				ok(Hasher.hasEventListener(HasherEvent.STOP), "Attached STOP Listener");
				
				Hasher.disableEvent(HasherEvent.STOP);
				
				Hasher.stop();
				
				var delayedStart = function(){
					ok(true, 'Didn\'t dispatched STOP event.');
					ok(! Hasher.isActive(), "Is not active");
					Hasher.removeAllEventListeners(HasherEvent.STOP);
					ok(! Hasher.hasEventListener(HasherEvent.STOP), "Removed INIT Listener");
					start();
				};
				
				setTimeout(delayedStart, 100);
				
			};
			
			test('disable INIT', disableInitTest);
			test('disable CHANGE', disableChangeTest);
			test('disable STOP', disableStopTest);
			
			/* === */
			
			/* ==== dispose ==== */
			
			module('dispose');
			
			var disposeTest = function(){
				stop(200);
				expect(5);
				
				ok((Hasher), "Hasher exists");
				
				Hasher.dispose();
				
				ok((! Hasher), "! Hasher");
				ok(('Hasher' in window), "Hasher in window");
				ok((Hasher === null), "Hasher === null");
				ok(!(typeof Hasher === 'undefined'), "!(typeof Hasher === 'undefined')");
				
				start();
			};
			
			test('dispose', disposeTest);
			
		</script>
	</body>
</html>
