/*
 * Hasher
 * - History Manager for rich-media applications.
 * Includes: MM.EventDispatcher (0.7.2), MM.queryUtils (0.7), MM.event-listenerFacade (0.3)
 * @author Miller Medeiros <http://www.millermedeiros.com/>
 * @version 0.9 (2010/06/28)
 * Released under the MIT License <http://www.opensource.org/licenses/mit-license.php>
 */
var MM=MM||{};MM.EventDispatcher=function(){this._handlers={}};MM.EventDispatcher.prototype={addEventListener:function(a,b){if(typeof this._handlers[a]=="undefined"){this._handlers[a]=[]}this._handlers[a].push(b)},removeEventListener:function(b,c){if(!this.hasEventListener(b)){return}var a=this._handlers[b],d=a.length;if(d==1){delete this._handlers[b]}else{while(d--){if(a[d]==c){a.splice(d,1);break}}}},removeAllEventListeners:function(){this._handlers={}},hasEventListener:function(a){return(typeof this._handlers[a]!="undefined")},dispatchEvent:function(d){d=(typeof d=="string")?{type:d}:d;if(this.hasEventListener(d.type)){var a=this._handlers[d.type],c,b,f=a.length;d.target=d.target||this;for(b=0;b<f;b++){c=a[b];c(d)}}}};var MM=MM||{};MM.queryUtils={getQueryString:function(a){a=a||location.href;a=a.replace(/#[\w\W]*/,"");var b=/\?[a-zA-Z0-9\=\&\%\$\-\_\.\+\!\*\'\(\)\,]+/.exec(a);return(b)?decodeURIComponent(b[0]):""},getQueryObject:function(a){return this.toQueryObject(this.getQueryString(a))},toQueryObject:function(d){var a=d.replace("?","").split("&"),c=a.length,b={};while(c--){a[c]=a[c].split("=");b[a[c][0]]=a[c][1]}return b},getParamValue:function(b,a){return this.getQueryObject(a)[b]},hasParam:function(c,a){var b=new RegExp("(\\?|&)"+c+"=","g");return b.test(this.getQueryString(a))},toQueryString:function(b){var a=[],c;for(c in b){if(b.hasOwnProperty(c)){a.push(c+"="+b[c])}}return(a.length)?"?"+a.join("&"):""}};var MM=MM||{};MM.event=MM.event||{};MM.event.addListener=function(c,a,b){if(c.addEventListener){c.addEventListener(a,b,false)}else{if(c.attachEvent){c.attachEvent("on"+a,b)}else{c["on"+a]=b}}};MM.event.removeListener=function(c,a,b){if(c.removeEventListener){c.removeEventListener(a,b,false)}else{if(c.detachEvent){c.detachEvent("on"+a,b)}else{c["on"+a]=null}}};var HasherEvent=function(a,c,b){this.type=a;this.oldHash=c;this.newHash=b};HasherEvent.prototype.toString=function(){return'[HasherEvent type="'+this.type+'" oldHash="'+this.oldHash+'" newHash="'+this.newHash+'"]'};HasherEvent.CHANGE="change";HasherEvent.INIT="init";HasherEvent.STOP="stop";(function(j,l,e){var d=new MM.EventDispatcher(),h,n,g,f=/msie (6|7)/.test(navigator.userAgent.toLowerCase())&&(!+"\v1"),b=("onhashchange" in j);function i(o){d.dispatchEvent(new HasherEvent(HasherEvent.CHANGE,h,o));h=o}function a(){g=l.createElement("iframe");g.src="about:blank";g.style.display="none";l.body.appendChild(g)}function c(){var o=g.contentWindow.document;o.open();o.write("<html><head><title>"+d.getTitle()+'</title><script type="text/javascript">var frameHash="'+d.getHash()+'";<\/script></head><body>&nbsp;</body></html>');o.close()}function m(){var o=d.getHash();if(o!=h){i(o)}}function k(){var p=d.getHash(),o=g.contentWindow.frameHash;if(o!=p&&o!=h){d.setHash(o);i(o)}else{if(p!=h){if(o!=p){c()}i(p)}}}this.Hasher=d;d.init=function(){var o=this.getHash();if(b){MM.event.removeListener(j,"hashchange",m);MM.event.addListener(j,"hashchange",m)}else{clearInterval(n);if(f){if(!g){a();c()}n=setInterval(k,25)}else{n=setInterval(m,25)}}this.dispatchEvent(new HasherEvent(HasherEvent.INIT,h,o));h=o};d.stop=function(){if(b){MM.event.removeListener(j,"hashchange",m)}else{clearInterval(n);n=null}this.dispatchEvent(new HasherEvent(HasherEvent.STOP,h,h))};d.getURL=function(){return location.href};d.getBaseURL=function(){return location.href.replace(/(\?.*)|(\#.*)/,"")};d.setHash=function(o){location.hash=o};d.getHash=function(){var o=/#(.*)$/.exec(this.getURL());return(o&&o[1])?decodeURIComponent(o[1]):""};d.getHashAsArray=function(q){q=q||"/";var p=this.getHash(),o=new RegExp("^\\"+q+"|\\"+q+"$","g");p=p.replace(o,"");return p.split(q)};d.getHashQuery=function(){return MM.queryUtils.getQueryString(this.getHash()).substr(1)};d.getHashQueryAsObject=function(){return MM.queryUtils.toQueryObject(this.getHashQuery())};d.getHashQueryParam=function(o){return MM.queryUtils.getParamValue(o,this.getHash())};d.setTitle=function(o){l.title=o};d.getTitle=function(){return l.title};d.back=function(){history.back()};d.forward=function(){history.forward()};d.go=function(o){history.go(o)}}(window,document));