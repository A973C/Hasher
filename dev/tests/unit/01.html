<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html>
	<head>
		<link rel="stylesheet" href="./qunit/qunit.css" type="text/css" media="screen" />
		<script type="text/javascript" src="./qunit/qunit.js"></script>
		<script type="text/javascript" src="../../lib/MM_EventDispatcher.js"></script>
		<script type="text/javascript" src="../../lib/MM_queryUtils.js"></script>
		<script type="text/javascript" src="../../lib/MM_event-listenerFacade.js"></script>
		<script type="text/javascript" src="../../src/HasherEvent.js"></script>
		<script type="text/javascript" src="../../src/Hasher.js"></script>
		<title>Untitled</title>
	</head>
	<body>
		<h1 id="qunit-header">Hasher basic unit test</h1>
		<h2 id="qunit-banner"></h2>
		<h2 id="qunit-userAgent"></h2>
		<ol id="qunit-tests"></ol>
		<script type="text/javascript">
			
			location.hash = ''; //resets location.hash

			var testsHashs = [
				['foo', 'Foo Bar', ''],
				['dolor', 'Dolor Sit Amet', ''],
				['sit-amet/ipsum/?dolor=ipsum&maecennas=ullamcor', 'Sit Amet Ipsum', 'dolor=ipsum&maecennas=ullamcor'],
				['Spêçïãl/Chårs FTW', 'Spêçïãl Chårs', ''],
				['/asd', 'Asd', ''],
				['/asd/qwerty/?foo=bar', 'Qwerty / Asd / ? Foo = Bar', 'foo=bar'],
				['/asd/qwerty/', 'Asd Qwerty', '']
			];
			
			
			//-- init hasher test
			
			test("init hasher", function(){
				stop(200);
				expect(4);
				
				ok(! Hasher.hasEventListener(HasherEvent.INIT), "No INIT Listener");
				
				Hasher.addEventListener(HasherEvent.INIT, function(){				
					ok(true, "HasherEvent.INIT dispatched");
					
					Hasher.removeEventListener(HasherEvent.INIT, arguments.callee);
					ok(! Hasher.hasEventListener(HasherEvent.INIT), "Removed INIT Listener");
					
					start();
				});
				
				ok(Hasher.hasEventListener(HasherEvent.INIT), "Added INIT Listener");
				
				Hasher.init();
			});
			
			
			//-- set/get hash/title value
			
			module('set/get hash/title value');
			
			for(var i=0, t=testsHashs.length; i<t; i++){
				doChangeTest(i);
			}
			
			function doChangeTest(n){
				
				var testName = '#'+(n+1);
				
				var hash = testsHashs[n][0];
				var oldHash = (n > 0)? testsHashs[n-1][0] : '';
				var title = testsHashs[n][1];
				var hashQuery = testsHashs[n][2];
				
				var testFn = function(){
					stop(500);
					expect(11);
					
					ok(! Hasher.hasEventListener(HasherEvent.CHANGE), "No CHANGE Listener");
					
					Hasher.addEventListener(HasherEvent.CHANGE, function(evt){
						ok(true, "HasherEvent.CHANGE dispatched");
						
						ok((evt.oldHash !== Hasher.getHash()), "Hash value really changed.");
						
						Hasher.removeEventListener(HasherEvent.CHANGE, arguments.callee);
						ok( ! Hasher.hasEventListener(HasherEvent.CHANGE), "Removed CHANGE Listener");
						
						equals(evt.oldHash, oldHash, "HasherEvent.oldHash");
						equals(Hasher.getHash(), evt.newHash, "HasherEvent.newHash == Hasher.getHash()");
						
						start();
					});
					
					ok(Hasher.hasEventListener(HasherEvent.CHANGE), "Attached CHANGE Listener");
					
					Hasher.setHash(hash);
					equals(Hasher.getHash(), hash, "Hasher.setHash() & Hasher.getHash()");
					
					// simple substring to test if regex is correct
					var tmpHash = (hash.charAt(0) == '/')? hash.substr(1) : hash;
					tmpHash = (tmpHash.charAt(tmpHash.length -1 ) == '/')? tmpHash.substring(0, tmpHash.length -1) : tmpHash;
					var hashArray = tmpHash.split('/');
					
					same(Hasher.getHashAsArray(), hashArray, "Hasher.getHashAsArray()");
					
					same(Hasher.getHashQuery(), hashQuery, "Hasher.getHashQuery()");
					
					Hasher.setTitle(title);
					equal(Hasher.getTitle(), document.title, "Hasher.setTitle() & Hasher.getTitle()");
				};
				
				test(testName, testFn);
				
			}
			
			
			//-- back
			
			module('back');
			
			var i = testsHashs.length - 1;
			
			while(i--){
				doBackTest(i);
			}
			
			
			function doBackTest(n){
				
				var testName = '#'+(n+1);
				
				var hash = testsHashs[n][0];
				var title = testsHashs[n][1];
				
				var testFn = function(){
					stop(200);
					expect(7);
					
					ok(!Hasher.hasEventListener(HasherEvent.CHANGE), "No CHANGE Listener");
					
					Hasher.addEventListener(HasherEvent.CHANGE, function(evt){
					
						ok(true, "HasherEvent.CHANGE dispatched");
						
						Hasher.removeEventListener(HasherEvent.CHANGE, arguments.callee);
						ok(!Hasher.hasEventListener(HasherEvent.CHANGE), "Removed CHANGE Listener");
						
						equals(Hasher.getHash(), evt.newHash, "HasherEvent.newHash == Hasher.getHash()");
						equals(Hasher.getHash(), hash, "Hasher.getHash()");
						
						// simple substring to test if regex is correct
						var tmpHash = (hash.charAt(0) == '/')? hash.substr(1) : hash;
						tmpHash = (tmpHash.charAt(tmpHash.length -1 ) == '/')? tmpHash.substring(0, tmpHash.length -1) : tmpHash;
						var hashArray = tmpHash.split('/');
						
						same(Hasher.getHashAsArray(), hashArray, "Hasher.getHashAsArray()");
						
						start();
						
					});
					
					ok(Hasher.hasEventListener(HasherEvent.CHANGE), "Attached CHANGE Listener");
					
					Hasher.back();
				};
				
				test(testName, testFn);
			}
			
			
			//-- forward
			
			module('forward');
			
			for(var i=1, t=testsHashs.length; i<t; i++){
				doForwardTest(i);
			}
			
			
			function doForwardTest(n){
				
				var testName = '#'+(n+1);
				
				var hash = testsHashs[n][0];
				var title = testsHashs[n][1];
				
				var testFn = function(){
					stop(200);
					expect(7);
					
					ok(!Hasher.hasEventListener(HasherEvent.CHANGE), "No CHANGE Listener");
					
					Hasher.addEventListener(HasherEvent.CHANGE, function(evt){
					
						ok(true, "HasherEvent.CHANGE dispatched");
						
						Hasher.removeEventListener(HasherEvent.CHANGE, arguments.callee);
						ok(!Hasher.hasEventListener(HasherEvent.CHANGE), "Removed CHANGE Listener");
						
						equals(Hasher.getHash(), evt.newHash, "HasherEvent.newHash == Hasher.getHash()");
						equals(Hasher.getHash(), hash, "Hasher.getHash()");
						
						// simple substring to test if regex is correct
						var tmpHash = (hash.charAt(0) == '/')? hash.substr(1) : hash;
						tmpHash = (tmpHash.charAt(tmpHash.length -1 ) == '/')? tmpHash.substring(0, tmpHash.length -1) : tmpHash;
						var hashArray = tmpHash.split('/');
						
						same(Hasher.getHashAsArray(), hashArray, "Hasher.getHashAsArray()");
						
						start();
						
					});
					
					ok(Hasher.hasEventListener(HasherEvent.CHANGE), "Attached CHANGE Listener");
					
					Hasher.forward();
				};
				
				test(testName, testFn);
			}
			
		</script>
	</body>
</html>
